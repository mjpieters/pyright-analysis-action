name: Action checks
on:
  push:
    branches: [ "main" ]
    tags: [ "image/v*.*.*" ]
  pull_request:
  merge_group:

env:
  FORCE_COLOR: 1
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

permissions: {}

jobs:
  python-lint:
    runs-on: ubuntu-latest
    name: "Python linting"
    permissions:
      contents: read
    env:
      UV_FROZEN: true

    steps:
    - uses: actions/checkout@93cb6efe18208431cddfb8368fd83d5badbf9bfd # v5.0.1
      with:
        persist-credentials: false

    - name: Set up Python ðŸ
      id: python
      uses: actions/setup-python@a309ff8b426b58ec0e2a45f0f869d46889d02405 # v6.2.0
      with:
        python-version-file: "pyproject.toml"

    - name: Install uv
      uses: astral-sh/setup-uv@eac588ad8def6316056a12d4907a9d4d84ff7a3b # v7.3.0
      with:
        enable-cache: | # zizmor: ignore[cache-poisoning] cache is disabled when publishing to prevent poisoning
          ${{ github.ref_type == 'tag' && 'false' || 'auto' }}
        cache-dependency-glob: "uv.lock"
        python-version: ${{ steps.python.outputs.python-path }}
        activate-environment: true

    - name: Check lock is up-to-date
      run: |
        uv lock --check

    - name: Install dependencies
      run: |
        uv sync

    - name: Check file formatting
      uses: astral-sh/ruff-action@4919ec5cf1f49eff0871dbcea0da843445b837e6 # v3.6.1
      with:
        args: "format --check"

    - name: Lint with ruff
      env:
        RUFF_OUTPUT_FORMAT: github
      run: |
        ruff check

    - name: Typecheck with pyright
      uses: jakebailey/pyright-action@6cabc0f01c4994be48fd45cd9dbacdd6e1ee6e5e # v2.3.3
      with:
        version: PATH

  docker-lint:
    runs-on: ubuntu-latest
    name: "Docker linting"
    permissions:
      contents: read

    steps:
    - uses: actions/checkout@93cb6efe18208431cddfb8368fd83d5badbf9bfd # v5.0.1
      with:
        persist-credentials: false

    - uses: hadolint/hadolint-action@2332a7b74a6de0dda2e2221d575162eba76ba5e5 # v3.3.0
      name: Lint Dockerfile

  tests:
    runs-on: ubuntu-latest
    name: Python tests
    permissions:
      contents: read
      id-token: write  # needed for the codecov actions to obtain a OIDC token
    env:
      UV_FROZEN: true

    steps:
    - uses: actions/checkout@93cb6efe18208431cddfb8368fd83d5badbf9bfd # v5.0.1
      with:
        persist-credentials: false

    - name: Set up Python ðŸ
      id: python
      uses: actions/setup-python@a309ff8b426b58ec0e2a45f0f869d46889d02405 # v6.2.0
      with:
        python-version: 3.14

    - name: Install uv
      uses: astral-sh/setup-uv@eac588ad8def6316056a12d4907a9d4d84ff7a3b  # v7.3.0
      with:
        enable-cache: | # zizmor: ignore[cache-poisoning] cache is disabled when publishing to prevent poisoning
          ${{ github.ref_type == 'tag' && 'false' || 'auto' }}
        cache-dependency-glob: "uv.lock"
        python-version: ${{ steps.python.outputs.python-path }}

    - name: Install dependencies
      run: |
        uv sync

    - name: Test with pytest
      run: |
        uv run pytest -v --junitxml=junit.xml -o junit_family=legacy

    - name: Upload coverage reports to Codecov
      uses: codecov/codecov-action@671740ac38dd9b0130fbe1cec585b89eea48d3de # v5.5.2
      with:
        use_oidc: true

    - name: Upload test results to Codecov
      if: ${{ !cancelled() }}
      uses: codecov/codecov-action@671740ac38dd9b0130fbe1cec585b89eea48d3de # v5.5.2
      with:
        report_type: test_results
        use_oidc: true

  test-summary:
    name: Test and linting status
    runs-on: ubuntu-latest
    needs:
      - python-lint
      - docker-lint
      - tests
    if: always()
    steps:
    - name: Decide whether the needed jobs succeeded or failed
      uses: re-actors/alls-green@05ac9388f0aebcb5727afa17fcccfecd6f8ec5fe # v1.2.2
      with:
        jobs: ${{ toJSON(needs) }}

  build:
    runs-on: ubuntu-latest
    name: "Build"
    needs:
    - test-summary
    permissions:
      contents: read
      packages: write  # so we can log into the GitHub container registry and push
      attestations: write  # required to publish attestations
      id-token: write  # required to publish attestations

    steps:
    - uses: actions/checkout@93cb6efe18208431cddfb8368fd83d5badbf9bfd # v5.0.1
      with:
        persist-credentials: false

    - name: Build test image
      uses: docker/build-push-action@10e90e3645eae34f1e60eeb005ba3a3d33f178e8 # v6.19.2
      with:
        load: true
        tags: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:test
        build-args: |
          VERSION="0.1.0dev0+test"

    - name: Image smoketest
      env:
        TEST_TAG: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:test
      run: |
        docker run --rm "${TEST_TAG}" --smoketest

    - name: Extract docker image tag
      id: image_tag
      run: |
        if [[ "$GITHUB_REF" == refs/tags/image/* ]]; then
          echo "image_version=${GITHUB_REF_NAME#image/}" >> "$GITHUB_OUTPUT"
        else
          echo "image_version=" >> "$GITHUB_OUTPUT"
        fi

    - name: Extract metadata (tags, labels) for Docker
      id: meta
      uses: docker/metadata-action@c299e40c65443455700f0fdfc63efafe5b349051 # v5.10.0
      with:
        images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
        tags: |
            type=semver,pattern=v{{version}},value=${{ steps.image_tag.outputs.image_version }}
            type=ref,event=branch
            type=ref,event=pr

    - name: Log in to GitHub Container Registry
      uses: docker/login-action@c94ce9fb468520275223c153574b00df6fe4bcc9 # v3.7.0
      with:
        registry: ${{ env.REGISTRY }}
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    - uses: docker/build-push-action@10e90e3645eae34f1e60eeb005ba3a3d33f178e8 # v6.19.2
      name: Build and push image
      id: build-image
      with:
        context: .
        push: ${{ github.event_name == 'push' && github.ref_type == 'tag' }}
        tags: ${{ steps.meta.outputs.tags }}
        labels: ${{ steps.meta.outputs.labels }}
        annotations: ${{ steps.meta.outputs.annotations }}
        build-args: |
          VERSION=${{ fromJSON(steps.meta.outputs.json).labels['org.opencontainers.image.version'] }}

    - name: Generate artifact attestation
      if: ${{ github.event_name == 'push' && github.ref_type == 'tag' }}
      uses: actions/attest-build-provenance@96278af6caaf10aea03fd8d33a09a777ca52d62f # v3.2.0
      with:
        subject-name: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME}}
        subject-digest: ${{ steps.build-image.outputs.digest }}
